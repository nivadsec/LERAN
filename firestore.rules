/**
 * @fileoverview Firestore Security Rules for iTalk Academic Platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for student data and restricts access to classes, teachers, and announcements based on user roles.
 *
 * Data Structure:
 * - Student profiles are stored in /users/{userId}.
 * - Daily reports, test analyses, focus sessions, study topics, exam analyses and smart alerts are stored as subcollections under /users/{userId}.
 * - Class information is stored in /classes/{classId}.
 * - Teacher profiles are stored in /teachers/{teacherId}.
 * - Announcements are stored in /announcements/{announcementId}.
 *
 * Key Security Decisions:
 * - Students can only access their own profile and related data.
 * - Teachers can only access class information. Teacher profiles are not accessible to teachers themselves via the API.
 * - Listing the /users collection is explicitly denied.
 * - Announcements are publicly readable but only manageable by admins.
 *
 * Denormalization for Authorization: Not applicable, using path-based authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the requested user ID matches the authenticated user's ID.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user ID matches, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner and the resource exists.
     * @param {string} userId - The user ID to check for ownership.
     * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Restricts listing of all users.
     * @path /users
     * @allow N/A - Listing the entire collection is denied.
     * @deny Any attempt to list the collection.
     * @principle Prevents enumeration of all user accounts.
     */
    match /users {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages student profiles.
     * @path /users/{userId}
     * @allow (get) Authenticated user accessing their own profile.
     * @allow (create) Authenticated user can create their own profile if the userId matches their auth.uid.
     * @allow (update) Authenticated user updating their own profile.
     * @allow (delete) Authenticated user deleting their own profile.
     * @deny (get) Authenticated user accessing another user's profile.
     * @deny (create) Authenticated user creating a profile with a userId that doesn't match their auth.uid.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages daily reports for a student.
     * @path /users/{userId}/dailyReports/{reportId}
     * @allow (get) Authenticated user accessing their own daily report.
     * @allow (create) Authenticated user creating a daily report for themselves.
     * @allow (update) Authenticated user updating their own daily report.
     * @allow (delete) Authenticated user deleting their own daily report.
     * @deny (get) Authenticated user accessing another user's daily report.
     * @deny (create) Authenticated user creating a daily report for another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/dailyReports/{reportId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.studentId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages test analyses for a student.
     * @path /users/{userId}/testAnalyses/{analysisId}
     * @allow (get) Authenticated user accessing their own test analysis.
     * @allow (create) Authenticated user creating a test analysis for themselves.
     * @allow (update) Authenticated user updating their own test analysis.
     * @allow (delete) Authenticated user deleting their own test analysis.
     * @deny (get) Authenticated user accessing another user's test analysis.
     * @deny (create) Authenticated user creating a test analysis for another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/testAnalyses/{analysisId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.studentId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages exam analyses for a student.
     * @path /users/{userId}/examAnalyses/{analysisId}
     * @allow (get) Authenticated user accessing their own exam analysis.
     * @allow (create) Authenticated user creating an exam analysis for themselves.
     * @allow (update) Authenticated user updating their own exam analysis.
     * @allow (delete) Authenticated user deleting their own exam analysis.
     * @deny (get) Authenticated user accessing another user's exam analysis.
     * @deny (create) Authenticated user creating an exam analysis for another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/examAnalyses/{analysisId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId); // schema does not include studentId
        allow update: if isExistingOwner(userId);  // schema does not include studentId
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages focus sessions for a student.
     * @path /users/{userId}/focusSessions/{sessionId}
     * @allow (get) Authenticated user accessing their own focus session.
     * @allow (create) Authenticated user creating a focus session for themselves.
     * @allow (update) Authenticated user updating their own focus session.
     * @allow (delete) Authenticated user deleting their own focus session.
     * @deny (get) Authenticated user accessing another user's focus session.
     * @deny (create) Authenticated user creating a focus session for another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/focusSessions/{sessionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.studentId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages study topics for a student.
     * @path /users/{userId}/studyTopics/{topicId}
     * @allow (get) Authenticated user accessing their own study topic.
     * @allow (create) Authenticated user creating a study topic for themselves.
     * @allow (update) Authenticated user updating their own study topic.
     * @allow (delete) Authenticated user deleting their own study topic.
     * @deny (get) Authenticated user accessing another user's study topic.
     * @deny (create) Authenticated user creating a study topic for another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/studyTopics/{topicId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.studentId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages classes.
     * @path /classes/{classId}
     */
    match /classes/{classId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages teachers.
     * @path /teachers/{teacherId}
     */
    match /teachers/{teacherId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages smart alerts for a student.
     * @path /users/{userId}/smartAlerts/{alertId}
     * @allow (get) Authenticated user accessing their own smart alert.
     * @allow (create) Authenticated user creating a smart alert for themselves.
     * @allow (update) Authenticated user updating their own smart alert.
     * @allow (delete) Authenticated user deleting their own smart alert.
     * @deny (get) Authenticated user accessing another user's smart alert.
     * @deny (create) Authenticated user creating a smart alert for another user.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/smartAlerts/{alertId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.studentId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages announcements.
     * @path /announcements/{announcementId}
     */
    match /announcements/{announcementId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}