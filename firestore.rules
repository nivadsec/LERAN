/**
 * @fileoverview Firestore Security Rules for the iTalk Academic Platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for student data,
 * combined with role-based access for administrative functions. Students
 * can only access their own data, while administrators have broader permissions.
 *
 * Data Structure:
 * - User-specific data (daily reports, test analyses, etc.) is nested under
 *   /users/{userId}.
 * - Class and teacher data is stored in top-level collections (/classes, /teachers).
 * - Announcements are stored in a top-level collection (/announcements) and are publicly readable.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied to protect user privacy.
 * - Data validation is relaxed in this prototype to allow for rapid iteration.
 * - Role-based access is planned but not fully implemented in this prototype.
 *
 * Denormalization for Authorization:
 *  - This ruleset avoids `get()` calls by relying on path-based authorization
 *    for user-owned data. For example, access to /users/{userId}/dailyReports/{reportId}
 *    is controlled solely by the {userId} parameter, ensuring that only the
 *    authenticated user with the matching ID can access the data.
 *
 * Structural Segregation:
 *  - The decision to store private student data under /users/{userId} and public
 *    announcements in a top-level /announcements collection ensures secure and
 *    performant list operations. Students cannot list all announcements, but they
 *    can list their own daily reports.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource based on the provided userId.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is the owner of an existing resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rule for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile if the userId matches their auth.uid. Example: A user with auth.uid "user123" can create a document at /users/user123.
     * @allow (get) - Authenticated user can read their own profile if the userId matches their auth.uid. Example: A user with auth.uid "user123" can read the document at /users/user123.
     * @allow (update) - Authenticated user can update their own profile if the userId matches their auth.uid. Example: A user with auth.uid "user123" can update the document at /users/user123.
     * @allow (delete) - Authenticated user can delete their own profile if the userId matches their auth.uid and the document exists.
     * @deny (list) - Listing all users is not allowed.
     * @deny (create) - Unauthenticated users cannot create user profiles. Example: An unauthenticated user attempts to create a document at /users/user123.
     * @deny (update) - Another authenticated user cannot update a profile. Example: A user with auth.uid "user456" attempts to update the document at /users/user123.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/dailyReports/{reportId} collection.
     * @path /users/{userId}/dailyReports/{reportId}
     * @allow (create) - Authenticated user can create a daily report under their own profile if the userId matches their auth.uid. Example: A user with auth.uid "user123" can create a document at /users/user123/dailyReports/report456.
     * @allow (get) - Authenticated user can read a daily report under their own profile if the userId matches their auth.uid. Example: A user with auth.uid "user123" can read the document at /users/user123/dailyReports/report456.
     * @allow (update) - Authenticated user can update a daily report under their own profile if the userId matches their auth.uid. Example: A user with auth.uid "user123" can update the document at /users/user123/dailyReports/report456.
     * @allow (delete) - Authenticated user can delete a daily report under their own profile if the userId matches their auth.uid and the document exists.
     * @allow (list) - Authenticated user can list daily reports under their own profile if the userId matches their auth.uid.
     * @deny (create) - Unauthenticated users cannot create daily reports. Example: An unauthenticated user attempts to create a document at /users/user123/dailyReports/report456.
     * @deny (update) - Another authenticated user cannot update a daily report. Example: A user with auth.uid "user456" attempts to update the document at /users/user123/dailyReports/report456.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree. Path-based ownership ensures authorization independence.
     */
    match /users/{userId}/dailyReports/{reportId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.studentId == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/testAnalyses/{analysisId} collection.
     * @path /users/{userId}/testAnalyses/{analysisId}
     * @allow (create) - Authenticated user can create a test analysis under their own profile if the userId matches their auth.uid.
     * @allow (get) - Authenticated user can read a test analysis under their own profile if the userId matches their auth.uid.
     * @allow (update) - Authenticated user can update a test analysis under their own profile if the userId matches their auth.uid.
     * @allow (delete) - Authenticated user can delete a test analysis under their own profile if the userId matches their auth.uid and the document exists.
     * @allow (list) - Authenticated user can list test analyses under their own profile if the userId matches their auth.uid.
     * @deny (create) - Unauthenticated users cannot create test analyses.
     * @deny (update) - Another authenticated user cannot update a test analysis.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/testAnalyses/{analysisId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.studentId == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

     /**
     * @description Rule for the /users/{userId}/examAnalyses/{analysisId} collection.
     * @path /users/{userId}/examAnalyses/{analysisId}
     * @allow (create) - Authenticated user can create an exam analysis under their own profile if the userId matches their auth.uid.
     * @allow (get) - Authenticated user can read an exam analysis under their own profile if the userId matches their auth.uid.
     * @allow (update) - Authenticated user can update an exam analysis under their own profile if the userId matches their auth.uid.
     * @allow (delete) - Authenticated user can delete an exam analysis under their own profile if the userId matches their auth.uid and the document exists.
     * @allow (list) - Authenticated user can list exam analyses under their own profile if the userId matches their auth.uid.
     * @deny (create) - Unauthenticated users cannot create exam analyses.
     * @deny (update) - Another authenticated user cannot update an exam analysis.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/examAnalyses/{analysisId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.studentId == userId;
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/focusSessions/{sessionId} collection.
     * @path /users/{userId}/focusSessions/{sessionId}
     * @allow (create) - Authenticated user can create a focus session under their own profile if the userId matches their auth.uid.
     * @allow (get) - Authenticated user can read a focus session under their own profile if the userId matches their auth.uid.
     * @allow (update) - Authenticated user can update a focus session under their own profile if the userId matches their auth.uid.
     * @allow (delete) - Authenticated user can delete a focus session under their own profile if the userId matches their auth.uid and the document exists.
     * @allow (list) - Authenticated user can list focus sessions under their own profile if the userId matches their auth.uid.
     * @deny (create) - Unauthenticated users cannot create focus sessions.
     * @deny (update) - Another authenticated user cannot update a focus session.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/focusSessions/{sessionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.studentId == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{userId}/studyTopics/{topicId} collection.
     * @path /users/{userId}/studyTopics/{topicId}
     * @allow (create) - Authenticated user can create a study topic under their own profile if the userId matches their auth.uid.
     * @allow (get) - Authenticated user can read a study topic under their own profile if the userId matches their auth.uid.
     * @allow (update) - Authenticated user can update a study topic under their own profile if the userId matches their auth.uid.
     * @allow (delete) - Authenticated user can delete a study topic under their own profile if the userId matches their auth.uid and the document exists.
     * @allow (list) - Authenticated user can list study topics under their own profile if the userId matches their auth.uid.
     * @deny (create) - Unauthenticated users cannot create study topics.
     * @deny (update) - Another authenticated user cannot update a study topic.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/studyTopics/{topicId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.studentId == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /classes/{classId} collection.
     * @path /classes/{classId}
     * @allow (get) - Authenticated users can read class information.
     * @allow (list) - Authenticated users can list classes.
     * @deny (create) - Only admins can create classes. TODO: Add admin role check.
     * @deny (update) - Only admins can update classes. TODO: Add admin role check.
     * @deny (delete) - Only admins can delete classes. TODO: Add admin role check.
     * @principle Restricts write access to admins. Read access is public for all authenticated users.
     */
    match /classes/{classId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;  // TODO: Add admin role validation once the schema is updated with an ownership field.
      allow update: if false;  // TODO: Add admin role validation once the schema is updated with an ownership field.
      allow delete: if false;  // TODO: Add admin role validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rule for the /teachers/{teacherId} collection.
     * @path /teachers/{teacherId}
     * @allow (get) - Authenticated teachers can read their own profile.
     * @deny (list) - Listing all teachers is not allowed.
     * @deny (create) - Only admins can create teacher profiles. TODO: Add admin role check.
     * @deny (update) - Only admins can update teacher profiles. TODO: Add admin role check.
     * @deny (delete) - Only admins can delete teacher profiles. TODO: Add admin role check.
     * @principle Restricts write access to admins. Teachers can read their own profiles.
     */
    match /teachers/{teacherId} {
      allow get: if isSignedIn() && request.auth.uid == teacherId; // Assuming teacherId is the same as the user ID.
      allow list: if false;
      allow create: if false; // TODO: Add admin role validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add admin role validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add admin role validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rule for the /users/{userId}/smartAlerts/{alertId} collection.
     * @path /users/{userId}/smartAlerts/{alertId}
     * @allow (create) - Authenticated user can create a smart alert under their own profile if the userId matches their auth.uid.
     * @allow (get) - Authenticated user can read a smart alert under their own profile if the userId matches their auth.uid.
     * @allow (update) - Authenticated user can update a smart alert under their own profile if the userId matches their auth.uid.
     * @allow (delete) - Authenticated user can delete a smart alert under their own profile if the userId matches their auth.uid and the document exists.
     * @allow (list) - Authenticated user can list smart alerts under their own profile if the userId matches their auth.uid.
     * @deny (create) - Unauthenticated users cannot create smart alerts.
     * @deny (update) - Another authenticated user cannot update a smart alert.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/smartAlerts/{alertId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.studentId == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /announcements/{announcementId} collection.
     * @path /announcements/{announcementId}
     * @allow (get) - All users can read announcements.
     * @allow (list) - All users can list announcements.
     * @deny (create) - Only admins can create announcements. TODO: Add admin role check.
     * @deny (update) - Only admins can update announcements. TODO: Add admin role check.
     * @deny (delete) - Only admins can delete announcements. TODO: Add admin role check.
     * @principle Public read access with owner-only writes.
     */
    match /announcements/{announcementId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin role validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add admin role validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add admin role validation once the schema is updated with an ownership field.
    }
  }
}