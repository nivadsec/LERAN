rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows students to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create) - Authenticated user with ID matching the userId can create their profile.
     * @allow (get, list, update, delete) - Authenticated user with ID matching the userId can read, update, or delete their profile.
     * @deny (create, get, list, update, delete) - Any other user attempting to access this profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows students to manage their own daily reports.
     * @path /users/{userId}/dailyReports/{reportId}
     * @allow (create) - Authenticated user with ID matching the userId can create daily reports.
     * @allow (get, list, update, delete) - Authenticated user with ID matching the userId can read, update, or delete their own daily reports.
     * @deny (create, get, list, update, delete) - Any other user attempting to access this data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/dailyReports/{reportId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows students to manage their own test analysis data.
     * @path /users/{userId}/testAnalyses/{analysisId}
     * @allow (create) - Authenticated user with ID matching the userId can create test analyses.
     * @allow (get, list, update, delete) - Authenticated user with ID matching the userId can read, update, or delete their own test analyses.
     * @deny (create, get, list, update, delete) - Any other user attempting to access this data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/testAnalyses/{analysisId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows students to manage their own exam analysis data.
     * @path /users/{userId}/examAnalyses/{analysisId}
     * @allow (create) - Authenticated user with ID matching the userId can create exam analyses.
     * @allow (get, list, update, delete) - Authenticated user with ID matching the userId can read, update, or delete their own exam analyses.
     * @deny (create, get, list, update, delete) - Any other user attempting to access this data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/examAnalyses/{analysisId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(userId) {
            return isSignedIn() && request.auth.uid == userId;
        }

        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
    }

    /**
     * @description Allows students to manage their own focus session data.
     * @path /users/{userId}/focusSessions/{sessionId}
     * @allow (create) - Authenticated user with ID matching the userId can create focus sessions.
     * @allow (get, list, update, delete) - Authenticated user with ID matching the userId can read, update, or delete their own focus sessions.
     * @deny (create, get, list, update, delete) - Any other user attempting to access this data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/focusSessions/{sessionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows students to manage their own study topics data.
     * @path /users/{userId}/studyTopics/{topicId}
     * @allow (create) - Authenticated user with ID matching the userId can create study topics.
     * @allow (get, list, update, delete) - Authenticated user with ID matching the userId can read, update, or delete their own study topics.
     * @deny (create, get, list, update, delete) - Any other user attempting to access this data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/studyTopics/{topicId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows all users to read class information, but only allows admins to create, update, and delete.
     * @path /classes/{classId}
     * @allow (get, list) - Any authenticated user can read class information.
     * @deny (create, update, delete) - Only admins can create, update, and delete classes.
     * @principle Restricts write access to admins.
     */
    match /classes/{classId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return false; // Replace with your actual admin check (e.g., custom claim)
      }

      allow get: if isSignedIn(); // TODO: Refine read permissions for classes (e.g., based on teacher or student role).
      allow list: if isSignedIn();
      allow create: if isAdmin(); // TODO: Implement admin role check.
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows teachers to read their own profile, but only allows admins to create, update, and delete.
     * @path /teachers/{teacherId}
     * @allow (get) - Authenticated teacher with ID matching the teacherId can read their own profile.
     * @deny (create, list, update, delete) - Only admins can create, list, update, and delete teacher profiles.
     * @principle Restricts write access to admins, allows teachers to view their own profiles.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isAdmin() {
        return false; // Replace with your actual admin check (e.g., custom claim)
      }

      allow get: if isOwner(teacherId);
      allow list: if isAdmin();
      allow create: if isAdmin(); // TODO: Implement admin role check.
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows students to read their own smart alerts.
     * @path /users/{userId}/smartAlerts/{alertId}
     * @allow (get, list) - Authenticated user with ID matching the userId can read their own smart alerts.
     * @deny (create, update, delete) - Smart alerts are managed by the system, not directly created, updated, or deleted by users.
     * @principle Enforces document ownership for reads.
     */
    match /users/{userId}/smartAlerts/{alertId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if false; // SmartAlerts should be created/managed by a trusted function, not directly by users.
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows all users to read announcements, but only allows admins to create, update, and delete.
     * @path /announcements/{announcementId}
     * @allow (get, list) - Any authenticated user can read announcements.
     * @deny (create, update, delete) - Only admins can create, update, and delete announcements.
     * @principle Restricts write access to admins, allows public read access.
     */
    match /announcements/{announcementId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return false; // Replace with your actual admin check (e.g., custom claim)
      }

      allow get: if true;
      allow list: if isSignedIn();
      allow create: if isAdmin(); // TODO: Implement admin role check.
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}