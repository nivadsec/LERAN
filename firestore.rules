/**
 * @fileoverview Firestore Security Rules for the iTalk Academic platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for student data,
 * ensuring that students can only access their own information. Announcements
 * are publicly readable, while administrative data (teachers, classes)
 * have restricted access.
 *
 * Data Structure:
 * - /users/{userId}: Student profiles, owned by the user.
 * - /users/{userId}/dailyReports/{reportId}: Daily reports for each student.
 * - /users/{userId}/testAnalyses/{analysisId}: Test analysis data for each student.
 * - /users/{userId}/examAnalyses/{analysisId}: Exam analysis data for each student.
 * - /users/{userId}/focusSessions/{sessionId}: Focus session ratings for each student.
 * - /users/{userId}/studyTopics/{topicId}: Study topics for each student.
 * - /users/{userId}/smartAlerts/{alertId}: Smart alerts for each student.
 * - /classes/{classId}: Class information, restricted access.
 * - /teachers/{teacherId}: Teacher profiles, restricted access.
 * - /announcements/{announcementId}: General announcements, publicly readable.
 *
 * Key Security Decisions:
 * - Students have full CRUD access only to their own data under their /users/{userId} path.
 * - Teachers and Classes are secured with placeholder rules until roles are defined.
 * - Announcements are publicly readable.
 * - User listing is implicitly denied (no top-level `list` rule for `/users`).
 *
 * Denormalization for Authorization:
 * The current data model leverages path-based ownership, where the `userId` is part of the document path.
 * This allows direct enforcement of ownership without requiring extra `get()` calls. For example,
 * a rule on `/users/{userId}/dailyReports/{reportId}` can directly check `isOwner(userId)` without
 * fetching the user's profile.
 *
 * Structural Segregation:
 * Private student data (daily reports, test analyses, focus sessions) is stored in user-specific
 * subcollections under `/users/{userId}`. This ensures that listing operations on these subcollections
 * are always restricted to the owner.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the requested user ID matches the authenticated user ID
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if the user is the existing owner
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    // Helper function to check if the user has an 'isAdmin' flag in their user document.
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    /**
     * @description Allows students to manage their own profile and admins to list all users.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      allow list: if isAdmin();
    }

    /**
     * @description Allows students to manage their own daily reports.
     * @path /users/{userId}/dailyReports/{reportId}
     */
    match /users/{userId}/dailyReports/{reportId} {
      allow read, list, write: if isOwner(userId);
    }

     /**
      * @description Allows students to manage their own test analyses.
      * @path /users/{userId}/testAnalyses/{analysisId}
      */
    match /users/{userId}/testAnalyses/{analysisId} {
      allow read, list, write: if isOwner(userId);
    }

     /**
      * @description Allows students to manage their own exam analyses.
      * @path /users/{userId}/examAnalyses/{analysisId}
      */
    match /users/{userId}/examAnalyses/{analysisId} {
       allow read, list, write: if isOwner(userId);
    }

    /**
     * @description Allows students to manage their own focus sessions.
     * @path /users/{userId}/focusSessions/{sessionId}
     */
    match /users/{userId}/focusSessions/{sessionId} {
      allow read, list, write: if isOwner(userId);
    }

     /**
      * @description Allows students to manage their own study topics.
      * @path /users/{userId}/studyTopics/{topicId}
      */
    match /users/{userId}/studyTopics/{topicId} {
      allow read, list, write: if isOwner(userId);
    }

    /**
     * @description Placeholder rules for classes. Access will be defined later.
     * @path /classes/{classId}
     */
    match /classes/{classId} {
      allow read, list: if true;
      allow write: if false; // TODO: Add role-based access
    }

    /**
     * @description Placeholder rules for teachers. Access will be defined later.
     * @path /teachers/{teacherId}
     */
    match /teachers/{teacherId} {
      allow read, list: if true;
      allow write: if false; // TODO: Add role-based access
    }

     /**
      * @description Allows students to read their own smart alerts.
      * @path /users/{userId}/smartAlerts/{alertId}
      */
    match /users/{userId}/smartAlerts/{alertId} {
      allow read, list: if isOwner(userId);
      allow write: if false; // Only backend/admins can create alerts
    }

    /**
     * @description Allows anyone to read announcements; only admins can manage them.
     * @path /announcements/{announcementId}
     */
    match /announcements/{announcementId} {
      allow read, list: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}
