/**
 * @fileoverview Firestore Security Rules for the iTalk Academic platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for student data,
 * ensuring that students can only access their own information. Announcements
 * are publicly readable, while administrative data (teachers, classes)
 * have restricted access.
 *
 * Data Structure:
 * - /users/{userId}: Student profiles, owned by the user.
 * - /users/{userId}/dailyReports/{reportId}: Daily reports for each student.
 * - /users/{userId}/testAnalyses/{analysisId}: Test analysis data for each student.
 * - /users/{userId}/examAnalyses/{analysisId}: Exam analysis data for each student.
 * - /users/{userId}/focusSessions/{sessionId}: Focus session ratings for each student.
 * - /users/{userId}/studyTopics/{topicId}: Study topics for each student.
 * - /users/{userId}/smartAlerts/{alertId}: Smart alerts for each student.
 * - /classes/{classId}: Class information, restricted access.
 * - /teachers/{teacherId}: Teacher profiles, restricted access.
 * - /announcements/{announcementId}: General announcements, publicly readable.
 *
 * Key Security Decisions:
 * - Students have full CRUD access only to their own data under their /users/{userId} path.
 * - Teachers and Classes are secured with placeholder rules until roles are defined.
 * - Announcements are publicly readable.
 * - User listing is implicitly denied (no top-level `list` rule for `/users`).
 *
 * Denormalization for Authorization:
 * The current data model leverages path-based ownership, where the `userId` is part of the document path.
 * This allows direct enforcement of ownership without requiring extra `get()` calls. For example,
 * a rule on `/users/{userId}/dailyReports/{reportId}` can directly check `isOwner(userId)` without
 * fetching the user's profile.
 *
 * Structural Segregation:
 * Private student data (daily reports, test analyses, focus sessions) is stored in user-specific
 * subcollections under `/users/{userId}`. This ensures that listing operations on these subcollections
 * are always restricted to the owner.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows students to manage their own profile.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user_abc' can create their profile if userId == 'user_abc'.
     * @allow (get) - User with UID 'user_abc' can read their profile if userId == 'user_abc'.
     * @allow (update) - User with UID 'user_abc' can update their profile if userId == 'user_abc'.
     * @allow (delete) - User with UID 'user_abc' can delete their profile if userId == 'user_abc'.
     * @deny (create) - User with UID 'user_def' cannot create a profile under /users/user_abc.
     * @deny (get) - User with UID 'user_def' cannot read the profile under /users/user_abc.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the requested user ID matches the authenticated user ID
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Helper function to check if the user is the existing owner
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allows a user to create their own profile if the userId matches their authentication UID.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;

      // Allows a user to read their own profile
      allow get: if isSignedIn() && isOwner(userId);

      // Allows a user to list their own profile - this is technically not possible
      allow list: if false;

      // Allows a user to update their own profile
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;

      // Allows a user to delete their own profile
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows students to manage their own daily reports.
     * @path /users/{userId}/dailyReports/{reportId}
     * @allow (create) - User with UID 'user_abc' can create a daily report under /users/user_abc/dailyReports.
     * @allow (get) - User with UID 'user_abc' can read a daily report under /users/user_abc/dailyReports.
     * @allow (update) - User with UID 'user_abc' can update a daily report under /users/user_abc/dailyReports.
     * @allow (delete) - User with UID 'user_abc' can delete a daily report under /users/user_abc/dailyReports.
     * @deny (create) - User with UID 'user_def' cannot create a daily report under /users/user_abc/dailyReports.
     * @deny (get) - User with UID 'user_def' cannot read a daily report under /users/user_abc/dailyReports.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/dailyReports/{reportId} {
      // Allows a user to create a daily report in their own user path
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.studentId == userId;

      // Allows a user to read a daily report from their own user path
      allow get: if isSignedIn() && isOwner(userId);

      // Allows a user to list daily reports from their own user path
      allow list: if isSignedIn() && isOwner(userId);

      // Allows a user to update a daily report in their own user path
      allow update: if isExistingOwner(userId) && request.resource.data.studentId == resource.data.studentId;

      // Allows a user to delete a daily report from their own user path
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Allows students to manage their own test analyses.
      * @path /users/{userId}/testAnalyses/{analysisId}
      * @allow (create) - User with UID 'user_abc' can create a test analysis under /users/user_abc/testAnalyses.
      * @allow (get) - User with UID 'user_abc' can read a test analysis under /users/user_abc/testAnalyses.
      * @allow (update) - User with UID 'user_abc' can update a test analysis under /users/user_abc/testAnalyses.
      * @allow (delete) - User with UID 'user_abc' can delete a test analysis under /users/user_abc/testAnalyses.
      * @deny (create) - User with UID 'user_def' cannot create a test analysis under /users/user_abc/testAnalyses.
      * @deny (get) - User with UID 'user_def' cannot read a test analysis under /users/user_abc/testAnalyses.
      * @principle Enforces document ownership for all operations.
      */
    match /users/{userId}/testAnalyses/{analysisId} {
      // Allows a user to create a test analysis in their own user path
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.studentId == userId;

      // Allows a user to read a test analysis from their own user path
      allow get: if isSignedIn() && isOwner(userId);

      // Allows a user to list test analyses from their own user path
      allow list: if isSignedIn() && isOwner(userId);

      // Allows a user to update a test analysis in their own user path
      allow update: if isExistingOwner(userId) && request.resource.data.studentId == resource.data.studentId;

      // Allows a user to delete a test analysis from their own user path
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Allows students to manage their own exam analyses.
      * @path /users/{userId}/examAnalyses/{analysisId}
      * @allow (create) - User with UID 'user_abc' can create a exam analysis under /users/user_abc/examAnalyses.
      * @allow (get) - User with UID 'user_abc' can read a exam analysis under /users/user_abc/examAnalyses.
      * @allow (update) - User with UID 'user_abc' can update a exam analysis under /users/user_abc/examAnalyses.
      * @allow (delete) - User with UID 'user_abc' can delete a exam analysis under /users/user_abc/examAnalyses.
      * @deny (create) - User with UID 'user_def' cannot create a exam analysis under /users/user_abc/examAnalyses.
      * @deny (get) - User with UID 'user_def' cannot read a exam analysis under /users/user_abc/examAnalyses.
      * @principle Enforces document ownership for all operations.
      */
    match /users/{userId}/examAnalyses/{analysisId} {
        // Allows a user to create an exam analysis in their own user path
        allow create: if isSignedIn() && isOwner(userId) && request.resource.data.studentId == userId;

        // Allows a user to read an exam analysis from their own user path
        allow get: if isSignedIn() && isOwner(userId);

        // Allows a user to list exam analysis from their own user path
        allow list: if isSignedIn() && isOwner(userId);

        // Allows a user to update an exam analysis in their own user path
        allow update: if isExistingOwner(userId) && request.resource.data.studentId == resource.data.studentId;

        // Allows a user to delete an exam analysis from their own user path
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows students to manage their own focus sessions.
     * @path /users/{userId}/focusSessions/{sessionId}
     * @allow (create) - User with UID 'user_abc' can create a focus session under /users/user_abc/focusSessions.
     * @allow (get) - User with UID 'user_abc' can read a focus session under /users/user_abc/focusSessions.
     * @allow (update) - User with UID 'user_abc' can update a focus session under /users/user_abc/focusSessions.
     * @allow (delete) - User with UID 'user_abc' can delete a focus session under /users/user_abc/focusSessions.
     * @deny (create) - User with UID 'user_def' cannot create a focus session under /users/user_abc/focusSessions.
     * @deny (get) - User with UID 'user_def' cannot read a focus session under /users/user_abc/focusSessions.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/focusSessions/{sessionId} {
      // Allows a user to create a focus session in their own user path
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.studentId == userId;

      // Allows a user to read a focus session from their own user path
      allow get: if isSignedIn() && isOwner(userId);

      // Allows a user to list focus sessions from their own user path
      allow list: if isSignedIn() && isOwner(userId);

      // Allows a user to update a focus session in their own user path
      allow update: if isExistingOwner(userId) && request.resource.data.studentId == resource.data.studentId;

      // Allows a user to delete a focus session from their own user path
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Allows students to manage their own study topics.
      * @path /users/{userId}/studyTopics/{topicId}
      * @allow (create) - User with UID 'user_abc' can create a study topic under /users/user_abc/studyTopics.
      * @allow (get) - User with UID 'user_abc' can read a study topic under /users/user_abc/studyTopics.
      * @allow (update) - User with UID 'user_abc' can update a study topic under /users/user_abc/studyTopics.
      * @allow (delete) - User with UID 'user_abc' can delete a study topic under /users/user_abc/studyTopics.
      * @deny (create) - User with UID 'user_def' cannot create a study topic under /users/user_abc/studyTopics.
      * @deny (get) - User with UID 'user_def' cannot read a study topic under /users/user_abc/studyTopics.
      * @principle Enforces document ownership for all operations.
      */
    match /users/{userId}/studyTopics/{topicId} {
      // Allows a user to create a study topic in their own user path
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.studentId == userId;

      // Allows a user to read a study topic from their own user path
      allow get: if isSignedIn() && isOwner(userId);

      // Allows a user to list study topics from their own user path
      allow list: if isSignedIn() && isOwner(userId);

      // Allows a user to update a study topic in their own user path
      allow update: if isExistingOwner(userId) && request.resource.data.studentId == resource.data.studentId;

      // Allows a user to delete a study topic from their own user path
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Placeholder rules for classes. Access will be defined later.
     * @path /classes/{classId}
     * @allow (get) - Anyone can get the class information.
     * @deny (create) - No one can create a class.
     * @principle Placeholder for future access control definition.
     */
    match /classes/{classId} {
      // Anyone can read class information
      allow get, list: if true;

      // No one can create, update, or delete classes without further role definition
      allow create, update, delete: if false; // TODO: Add role-based access
    }

    /**
     * @description Placeholder rules for teachers. Access will be defined later.
     * @path /teachers/{teacherId}
     * @allow (get) - Anyone can get teacher information.
     * @deny (create) - No one can create a teacher.
     * @principle Placeholder for future access control definition.
     */
    match /teachers/{teacherId} {
      // Anyone can read teacher information
      allow get, list: if true;

      // No one can create, update, or delete teachers without further role definition
      allow create, update, delete: if false; // TODO: Add role-based access
    }

     /**
      * @description Allows students to read their own smart alerts.
      * @path /users/{userId}/smartAlerts/{alertId}
      * @allow (create) - User with UID 'user_abc' can create a smartAlert under /users/user_abc/smartAlerts.
      * @allow (get) - User with UID 'user_abc' can read a smartAlert under /users/user_abc/smartAlerts.
      * @allow (update) - User with UID 'user_abc' can update a smartAlert under /users/user_abc/smartAlerts.
      * @allow (delete) - User with UID 'user_abc' can delete a smartAlert under /users/user_abc/smartAlerts.
      * @deny (create) - User with UID 'user_def' cannot create a smartAlert under /users/user_abc/smartAlerts.
      * @deny (get) - User with UID 'user_def' cannot read a smartAlert under /users/user_abc/smartAlerts.
      * @principle Enforces document ownership for reads; admins can manage all alerts.
      */
    match /users/{userId}/smartAlerts/{alertId} {
      // Allows a user to read a smart alert from their own user path
      allow get: if isSignedIn() && isOwner(userId);

      // Allows a user to list smart alerts from their own user path
      allow list: if isSignedIn() && isOwner(userId);

      // No one can create, update, or delete alerts
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read announcements; only admins can manage them.
     * @path /announcements/{announcementId}
     * @allow (get) - Any signed-in user can read an announcement.
     * @deny (create) - Only admins can create announcements (not implemented).
     * @principle Public read, restricted write.
     */
    match /announcements/{announcementId} {
      // Allows anyone to read announcements
      allow get, list: if true;

      // No one can create, update, or delete announcements without further role definition
      allow create, update, delete: if false; // TODO: Add role-based access for admins
    }
  }
}